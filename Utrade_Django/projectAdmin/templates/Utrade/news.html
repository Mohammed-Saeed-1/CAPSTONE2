{% extends 'after_base.html' %}
{% block title %}Fav{% endblock %}

{% load static %}

{% block content %}
<style>
  .row>* {
    padding-right: calc(var(--bs-gutter-x) * .0);
    padding-left: calc(var(--bs-gutter-x) * .0);
  }
  .newsCards {
    margin: 10px;
    border: 1px solid #e2e2e2;
    border-radius: 8px;
    transition: transform 0.2s, box-shadow 0.2s;
    padding: 12px;
  }

  /* .newsCards h2, span, p{
    margin: 10px;
  } */

  .newsCards:hover {
    transform: translateY(-5px);
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
  }

  .newsCards:hover h2 {
    color: #0d6efd;
  }

  .card-img {
    height: fit-content; /* Reduce the image height */
    object-fit: cover;
    border-radius: 8px;
    /* margin-left: -12px; */
  }

  .card-text {
    font-size: 0.8rem; /* Make the text smaller */
  }

  .card-title {
    font-size: 1rem; /* Reduce the title font size */
    font-weight: 600;
    color: #333;
  }

  .fs-13 {
    font-size: 0.7rem; /* Make the date text smaller */
    color: #666;
  }
  
  .custom-spinner .spinner-border {
  color: #007BFF; /* Change to the desired blue color */
  }
  #searchButton2{
    border-radius: 0px 5px 5px 0px;
  }
  #stockImagesContainer {
    overflow-x: auto;
    white-space: nowrap;
    display: flex;
    /* justify-content: center; */
    margin-bottom: -17px !important;
  }

  .stockImageContainer {
      border-radius: 100%;
      background-color: #3c91eb36;
      padding: 10px;
      margin-right: 7px;
      margin-left: 7px;
  }

  .stockImage {
      max-width: 35px;
      display: block; /* To remove extra space below inline-block elements */
  }
</style>

{% endblock content %}


{% block content2 %}

<main id="main" class="main">

  <div class="pagetitle">
    <h1>Stock News</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item active">News</li>
      </ol>
    </nav>
  </div><!-- End Page Title -->


  <div class="btn-group" role="group" aria-label="Basic radio toggle button group" style="margin-bottom: 25px;">
    <input type="radio" class="btn-check" name="btnradio" id="btnradio1" autocomplete="off" checked>
    <label onclick="togglePopular()" class="btn btn-outline-primary" for="btnradio1">Popular</label>
  
    <input type="radio" class="btn-check" name="btnradio" id="btnradio3" autocomplete="off">
    <label onclick="toggleFavorite()" class="btn btn-outline-primary" for="btnradio3">Favorite</label>
  </div>

  <!-- Popular -->
  <div id="PopularContainer" style="display: block;">

    <div class="card card-body">
      <div class="container mt-5">
        <div style="display: flex;">
          <div class="input-group mb-3">
            <input type="text" id="stockSymbol" class="form-control" placeholder="Enter Stock Symbol">
            <button class="btn btn-primary" id="searchButton">Search</button>
          </div>
          <div class="input-group mb-3">
            <!-- Filter dropdown -->
            <select id="filterDropdown" class="form-select" style="margin: 0px 0px 0px 137px;">
              <option value="RELEVANCE">RELEVANCE</option>
              <option value="LATEST">LATEST</option>
              <!-- <option value="TIME_FROM">TIME_FROM</option> -->
            </select>
            <div id="timeFromInput" style="display: none;">
              <input type="date" id="timeFromDate" class="form-control">
            </div>
            <button class="btn btn-primary" id="searchButton2" style="display: block;">GO</button>
            <button class="btn btn-primary" id="searchButton3" style="display: none;">GO</button>


          </div>
        </div>
        <!-- Loading spinner -->
        <div id="loadingSpinner" class="text-center mt-3 custom-spinner" style="display: none;">
          <div class="spinner-border text-primary" role="status">
          </div>
          <p style="color: #007BFF;">Loading news...</p>
        </div>
    
        <div id="newsResults" class="mt-3">
          <!-- Here the News -->
        </div>
      </div>
    </div>

  </div>

  <!-- Favorite -->
  <div id="FavoriteContainer" style="display: none;">

    <div class="card card-body">
      <div class="container mt-4">
          <div id="stockImagesContainer" class="mb-3">
              <!-- Stock images will be dynamically added here -->
          </div>
          <hr>
      </div>
      <div class="container mt-3">
        <div style="display: flex;">
          
          <div class="input-group mb-3">
            <!-- <input type="text" id="stockSymbolFav" class="form-control" placeholder="Enter Stock Symbol">
            <button class="btn btn-primary" id="searchButtonFav">Search</button> -->
            <h3 id="clickedFavSymbol">Click on a stock</h3>
          </div>
          <div class="input-group mb-3">
            <!-- Filter dropdown -->
            <select id="filterDropdownFav" class="form-select" style="margin: 0px 0px 0px 137px;">
              <option value="RELEVANCE">RELEVANCE</option>
              <option value="LATEST">LATEST</option>
              <!-- <option value="TIME_FROM">TIME_FROM</option> -->
            </select>
            <div id="timeFromInputFav" style="display: none;">
              <input type="date" id="timeFromDateFav" class="form-control">
            </div>
            <button class="btn btn-primary" id="searchButton2Fav" style="display: block;">GO</button>
            <button class="btn btn-primary" id="searchButton3Fav" style="display: none;">GO</button>


          </div>
        </div>
        <!-- Loading spinner -->
        <div id="loadingSpinnerFav" class="text-center mt-3 custom-spinner" style="display: none;">
          <div class="spinner-border text-primary" role="status">
          </div>
          <p style="color: #007BFF;">Loading news...</p>
        </div>
    
        <div id="newsResultsFav" class="mt-3">
          <!-- Here the News -->
        </div>
      </div>
    </div>

  </div>
</main><!-- End #main -->

<script>

    function togglePopular(){
      const PopularContainer = document.getElementById('PopularContainer');
      const FavoriteContainer = document.getElementById('FavoriteContainer');

      if(FavoriteContainer.style.display === 'block')
        FavoriteContainer.style.display = 'none';

      if(PopularContainer.style.display === 'none')
        PopularContainer.style.display = 'block';
    }
    function toggleFavorite(){
      const PopularContainer = document.getElementById('PopularContainer');
      const FavoriteContainer = document.getElementById('FavoriteContainer');

      if(PopularContainer.style.display === 'block')
        PopularContainer.style.display = 'none';

      if(FavoriteContainer.style.display === 'none')
        FavoriteContainer.style.display = 'block';
    }

    
</script>

<script>

  //$(document).ready(function () {

    // Sample data, replace this with your actual data
    var favoriteStocks = JSON.parse(localStorage.getItem('favoriteStocks')) || [];
    
    // Function to create stock images
    function createStockImages() {
        var container = document.getElementById('stockImagesContainer');

        // Clear existing images
        container.innerHTML = '';

        // Create images dynamically using a template string
        container.innerHTML = `
            ${favoriteStocks.map(symbol => `
                <div style="text-align: center;">
                    <div class="stockImageContainer" onclick="showFavStock('${symbol}')">
                        <img class="stockImage" src="https://fmpcloud.io/image-stock/${symbol}.png" alt="${symbol}" >
                    </div>
                    <p style="font-size: small; margin-top: 3px;">${symbol}</p>
                </div>
            `).join('')}
        `;
    }

    // Call the function to initially create images
    createStockImages();

    function showFavStock(symbol){
        document.getElementById('clickedFavSymbol').textContent = symbol;
        const filter = $("#filterDropdownFav").val();
        const timeFrom = $("#timeFromDateFav").val();
        fetchStockNewsFav(symbol, filter, timeFrom);
        $("#searchButton2Fav").css("display", "none");
        $("#searchButton3Fav").css("display", "block");
    }

    document.getElementById('searchButton2Fav').addEventListener('click', ()=>{
      const symbol = document.getElementById('clickedFavSymbol').textContent;
      const filter = $("#filterDropdownFav").val();
      const timeFrom = $("#timeFromDateFav").val();
      fetchStockNewsFav(symbol, filter, timeFrom);
      $("#searchButton2Fav").css("display", "none");
      $("#searchButton3Fav").css("display", "block");
    })

    document.getElementById('searchButton3Fav').addEventListener('click', ()=>{
      const symbol = document.getElementById('clickedFavSymbol').textContent;
      const filter = $("#filterDropdownFav").val();
      const timeFrom = $("#timeFromDateFav").val();
      fetchStockNewsFav(symbol, filter, timeFrom);
      $("#searchButton2Fav").css("display", "none");
      $("#searchButton3Fav").css("display", "block");
    })



      //click keybord (Enter)
      // $("#stockSymbolFav").keydown(function(event) {
      //     if (event.key === "Enter") {
      //         event.preventDefault();
      //         const stockSymbolFav = $("#stockSymbolFav").val();
      //         if (stockSymbolFav) {
      //           const filter = $("#filterDropdownFav").val();
      //           const timeFrom = $("#timeFromDateFav").val();
      //           fetchStockNewsFav(stockSymbolFav, filter, timeFrom);
      //           $("#searchButton2Fav").css("display", "none");
      //           $("#searchButton3Fav").css("display", "block");
      //         } else{
      //           window.location.href = "news.html";
      //         }
      //     }
      // });
      // //click search
      // $("#searchButtonFav").click(function () {
      //     const stockSymbolFav = $("#stockSymbolFav").val();
      //     if (stockSymbolFav) {
      //           const filter = $("#filterDropdownFav").val();
      //           const timeFrom = $("#timeFromDateFav").val();
      //           fetchStockNewsFav(stockSymbolFav, filter, timeFrom);
      //           $("#searchButton2Fav").css("display", "none");
      //           $("#searchButton3Fav").css("display", "block");
      //         } else{
      //           window.location.href = "news.html";
      //         }
      // });

      function fetchStockNewsFav(symbol,filter, timeFrom) {
        console.log("SEARCH:" + symbol);
        const apiKey = "T0PANKTWE68RFQVY"; //   , 14D1O5FPLVWK9QLQ
        let apiUrl = `https://www.alphavantage.co/query?function=NEWS_SENTIMENT&apikey=${apiKey}&topics=technology&tickers=${symbol}`;
        //const apiUrl = `https://www.alphavantage.co/query?function=NEWS_SENTIMENT&tickers=AAPL&apikey=demo`;

        if(filter === "RELEVANCE")
          apiUrl+= `&sort=RELEVANCE`;
        // else if (filter === "TIME_FROM") {
        //   const timeFromTimestamp = timeFrom.replace(/-/g, "").concat("T0130");
        //   apiUrl += `&time_from=${timeFromTimestamp}&sort=RELEVANCE`;
        //   //const apiUrl = `https://www.alphavantage.co/query?function=NEWS_SENTIMENT&tickers=AAPL&apikey=demo`;
        //   console.log(timeFromTimestamp);
        // }
        console.log("Filter: " + filter);

          // Clear previous results and Show the loading spinner
        $("#newsResultsFav").html("");
        $("#loadingSpinnerFav").show();
      
        $.get(apiUrl, function (data) {
          if (data && data.feed) {
            // Hide the loading spinner
            $("#loadingSpinnerFav").hide();

            // Display news cards with animation
            displayNewsWithAnimationFav(data.feed);
          } else {
            $("#newsResultsFav").html("<p>No news available for this stock symbol.</p>");
          }
        });
      }

        // Handle the search button click
      // $("#searchButton3Fav").click(function () {
      //   const stockSymbolFav = $("#stockSymbolFav").val();
      //     if (stockSymbolFav) {
      //       const filter = $("#filterDropdownFav").val();
      //       const timeFrom = $("#timeFromDateFav").val();
      //       fetchStockNewsFav(stockSymbolFav, filter, timeFrom);
      //     }
      // });

      // Show/hide the date input based on the filter selection
      // $("#filterDropdownFav").change(function () {
      //   const selectedFilter = $(this).val();
      //   if (selectedFilter === "TIME_FROM") {
      //     $("#timeFromInputFav").show();
      //   } else {
      //     $("#timeFromInputFav").hide();
      //   }
      // });

  //});

  function displayNewsWithAnimationFav(feed) {
    const newsResultsFavDiv = $("#newsResultsFav");
    newsResultsFavDiv.html(""); // Clear previous results

    for (const article of feed) {
      // Parse the timestamp
      const timestamp = article.time_published;
      const year = timestamp.substring(0, 4);
      const month = timestamp.substring(4, 6);
      const day = timestamp.substring(6, 8);
      const hour = timestamp.substring(9, 11);
      const minutes = timestamp.substring(11, 13);

      // Display the formatted date and time
      const formattedDateTime = `${day}/${month}/${year} ${hour}:${minutes}`;

      // Initially hide the news card
      const newsCard = `
        <a href="${article.url}" style="text-decoration: none; color: #333;" target="_blank">
          <div class="row newsCards" style="display: none;">
            <div class="col-lg-3 col-md-4 col-sm-12 grid-margin">
              <div class "position-relative">
                <div class="rotate-img">
                  <img src="${article.banner_image}" alt="thumb" class="img-fluid card-img">
                </div>
              </div>
            </div>
            <div class="col-lg-9 col-md-8 col-sm-12 grid-margin">
              <h2 class="mb-2 card-title" style="margin-left: 15px;">${article.title}</h2>
              <div class="fs-13 mb-2">
                <span style="margin-left: 15px;" class="mr-2">Photo</span>${formattedDateTime}
              </div>
              <p style="margin-left: 15px;" class="mb-0 card-text">${article.summary}</p>
            </div>
          </div>
        </a>
      `;
      newsResultsFavDiv.append(newsCard);

      // Use jQuery to animate the news card
      $(".newsCards:hidden").slideDown(800); // Adjust animation speed as needed
    }
  }
</script>
<!-- End of FAVORITE News -->

<script>

    // const storedSymbol = localStorage.getItem("SymbolNews");
    // // Check if the data is present
    // $(document).ready(function() {
    //   if (storedSymbol) {
    //     localStorage.setItem("SymbolNews", "");
    //     console.log("YEsssssssssssssssssssssssssssss");
    //     document.getElementById('stockSymbol').value = storedSymbol;
    //     $("#searchButton").click();
    //     $("#searchButton").click();

    //   }
    // });



    $(document).ready(function () {
        //click keybord (Enter)
        $("#stockSymbol").keydown(function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                const stockSymbol = $("#stockSymbol").val();
                if (stockSymbol) {
                  const filter = $("#filterDropdown").val();
                  const timeFrom = $("#timeFromDate").val();
                  fetchStockNews(stockSymbol, filter, timeFrom);
                  $("#searchButton2").css("display", "none");
                  $("#searchButton3").css("display", "block");
                } else{
                  window.location.href = "{% url 'Utrade:news' %}";
                }
            }
        });
        //click search
        $("#searchButton").click(function () {
            const stockSymbol = $("#stockSymbol").val();
            if (stockSymbol) {
                  const filter = $("#filterDropdown").val();
                  const timeFrom = $("#timeFromDate").val();
                  fetchStockNews(stockSymbol, filter, timeFrom);
                  $("#searchButton2").css("display", "none");
                  $("#searchButton3").css("display", "block");
                } else{
                  window.location.href = "{% url 'Utrade:news' %}";
                }
        });

        function fetchStockNews(symbol,filter, timeFrom) {
          console.log("SEARCH:" + symbol);
          const apiKey = "T0PANKTWE68RFQVY"; //T0PANKTWE68RFQVY
          let apiUrl = `https://www.alphavantage.co/query?function=NEWS_SENTIMENT&apikey=${apiKey}&topics=technology&tickers=${symbol}`;
          //const apiUrl = `https://www.alphavantage.co/query?function=NEWS_SENTIMENT&tickers=AAPL&apikey=demo`;

          if(filter === "RELEVANCE")
            apiUrl+= `&sort=RELEVANCE`;
          // else if (filter === "TIME_FROM") {
          //   const timeFromTimestamp = timeFrom.replace(/-/g, "").concat("T0130");
          //   apiUrl += `&time_from=${timeFromTimestamp}&sort=RELEVANCE`;
          //   //const apiUrl = `https://www.alphavantage.co/query?function=NEWS_SENTIMENT&tickers=AAPL&apikey=demo`;
          //   console.log(timeFromTimestamp);
          // }
          console.log("Filter: " + filter);

            // Clear previous results and Show the loading spinner
          $("#newsResults").html("");
          $("#loadingSpinner").show();
        
          $.get(apiUrl, function (data) {
            if (data && data.feed) {
              // Hide the loading spinner
              $("#loadingSpinner").hide();

              // Display news cards with animation
              displayNewsWithAnimation(data.feed);
            } else {
              $("#newsResults").html("<p>No news available for this stock symbol.</p>");
            }
          });
        }

          // Handle the search button click
        $("#searchButton3").click(function () {
          const stockSymbol = $("#stockSymbol").val();
            if (stockSymbol) {
              const filter = $("#filterDropdown").val();
              const timeFrom = $("#timeFromDate").val();
              fetchStockNews(stockSymbol, filter, timeFrom);
            }
        });
    });
</script>
  <!-- End of search News -->

<script>
  $(document).ready(function () {

    function fetchStockNews(filter, timeFrom) {
      const apiKey = "T0PANKTWE68RFQVY";//T0PANKTWE68RFQVY
      console.log("HOME");
      let apiUrl = `https://www.alphavantage.co/query?function=NEWS_SENTIMENT&apikey=${apiKey}&topics=technology`;
      //const apiUrl = `https://www.alphavantage.co/query?function=NEWS_SENTIMENT&tickers=AAPL&apikey=demo`;
      
      if(filter === "RELEVANCE")
        apiUrl+= `&sort=RELEVANCE`;
      // else if (filter === "TIME_FROM") {
      //   const timeFromTimestamp = timeFrom.replace(/-/g, "").concat("T0130");
      //   apiUrl += `&time_from=${timeFromTimestamp}&sort=RELEVANCE`;
      //   //const apiUrl = `https://www.alphavantage.co/query?function=NEWS_SENTIMENT&tickers=AAPL&apikey=demo`;
      //   console.log(timeFromTimestamp);
      // }
      console.log("Filter: " + filter);

      // Show the loading spinner
      $("#loadingSpinner").show();

      $.get(apiUrl, function (data) {
        if (data && data.feed) {
          // Hide the loading spinner
          $("#loadingSpinner").hide();

          // Display news cards with animation
          displayNewsWithAnimation(data.feed);
        } else {
          $("#newsResults").html("<p>No news available for this stock symbol.</p>");
        }
      });
    }

    // Show/hide the date input based on the filter selection
    // $("#filterDropdown").change(function () {
    //   const selectedFilter = $(this).val();
    //   if (selectedFilter === "TIME_FROM") {
    //     $("#timeFromInput").show();
    //   } else {
    //     $("#timeFromInput").hide();
    //   }
    // });

    // Handle the search button click
    $("#searchButton2").click(function () {
      const filter = $("#filterDropdown").val();
      const timeFrom = $("#timeFromDate").val();
      fetchStockNews(filter, timeFrom);
    });

    // Initialize with the default filter
    fetchStockNews("RELEVANCE", "");
  });

  function displayNewsWithAnimation(feed) {
    const newsResultsDiv = $("#newsResults");
    newsResultsDiv.html(""); // Clear previous results

    for (const article of feed) {
      // Parse the timestamp
      const timestamp = article.time_published;
      const year = timestamp.substring(0, 4);
      const month = timestamp.substring(4, 6);
      const day = timestamp.substring(6, 8);
      const hour = timestamp.substring(9, 11);
      const minutes = timestamp.substring(11, 13);

      // Display the formatted date and time
      const formattedDateTime = `${day}/${month}/${year} ${hour}:${minutes}`;

      // Initially hide the news card
      const newsCard = `
        <a href="${article.url}" style="text-decoration: none; color: #333;" target="_blank">
          <div class="row newsCards" style="display: none;">
            <div class="col-lg-3 col-md-4 col-sm-12 grid-margin">
              <div class "position-relative">
                <div class="rotate-img">
                  <img src="${article.banner_image}" alt="thumb" class="img-fluid card-img">
                </div>
              </div>
            </div>
            <div class="col-lg-9 col-md-8 col-sm-12 grid-margin">
              <h2 class="mb-2 card-title" style="margin-left: 15px;">${article.title}</h2>
              <div class="fs-13 mb-2">
                <span style="margin-left: 15px;" class="mr-2">Photo</span>${formattedDateTime}
              </div>
              <p style="margin-left: 15px;" class="mb-0 card-text">${article.summary}</p>
            </div>
          </div>
        </a>
      `;
      newsResultsDiv.append(newsCard);

      // Use jQuery to animate the news card
      $(".newsCards:hidden").slideDown(800); // Adjust animation speed as needed
    }
  }
</script>

{% endblock content2 %}